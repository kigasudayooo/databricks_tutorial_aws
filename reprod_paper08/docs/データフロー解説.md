# Paper08 データフロー解説

## 1. 研究概要

### 1.1 論文情報
- **タイトル**: Prevalence of patients with rheumatoid arthritis and age-stratified trends in clinical characteristics and treatment
- **著者**: Nakajima et al., 2020
- **ジャーナル**: Modern Rheumatology

### 1.2 研究目的
日本における関節リウマチ（RA）の有病率を推定し、年齢層別の治療動向と臨床特性を明らかにすること。

### 1.3 主要結果
| 指標 | 値 |
|------|-----|
| RA有病率 | 0.65% |
| RA患者数 | 825,772人 |
| 女性比率 | 76.3% |
| 平均年齢 | 65歳以上が55.2% |

---

## 2. メダリオンアーキテクチャ

本プロジェクトでは、データレイクハウスの標準的なアーキテクチャであるメダリオンアーキテクチャを採用しています。

```
┌─────────────────────────────────────────────────────────────────┐
│                     データフロー全体像                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌──────────┐      ┌──────────┐      ┌──────────┐             │
│   │  Bronze  │ ──→  │  Silver  │ ──→  │   Gold   │             │
│   │ (生データ) │      │(変換済み) │      │ (分析用)  │             │
│   └──────────┘      └──────────┘      └──────────┘             │
│        │                 │                 │                    │
│        ▼                 ▼                 ▼                    │
│   ・レセプトデータ    ・RA患者定義適用   ・Table 2: 年齢分布     │
│   ・傷病データ        ・薬剤使用フラグ   ・Table 3: 薬剤使用率   │
│   ・医薬品データ      ・手術フラグ       ・Table 4: 手術実施率   │
│   ・診療行為データ                       ・サマリー統計         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.1 Bronze Layer（生データ）

NDBレセプトデータを模したダミーデータを格納。

| ファイル | 内容 | レコード数 |
|---------|------|-----------|
| `patients.parquet` | 患者マスタ | 10,000人 |
| `re_receipt.parquet` | レセプト基本情報 | 約25,000件 |
| `sy_disease.parquet` | 傷病名（ICD-10コード） | 約63,000件 |
| `iy_medication.parquet` | 医薬品情報 | 約1,300件 |
| `si_procedure.parquet` | 診療行為情報 | 約25,500件 |

### 2.2 Silver Layer（変換済みデータ）

RA患者の定義を適用し、分析可能な形式に変換。

| ファイル | 内容 |
|---------|------|
| `ra_patients_def3.parquet` | Definition 3によるRA患者マスタ |
| `ra_definitions_summary.parquet` | 各定義の患者数比較 |

### 2.3 Gold Layer（分析結果）

論文のTable 2-4を再現した集計結果。

| ファイル | 内容 |
|---------|------|
| `table2_age_distribution.csv` | 年齢層別患者数・性別比 |
| `table3_medication.csv` | 年齢層別薬剤使用率 |
| `table4_procedures.csv` | 年齢層別手術実施率 |
| `summary.csv` | 主要指標サマリー |

---

## 3. RA患者定義

論文では7つの定義を検討し、**Definition 3**を主分析に採用しています。

### 3.1 ICD-10コード

RA関連のICD-10コードは以下の通り：

| コード | 疾患名 |
|--------|--------|
| M05.x | 血清反応陽性関節リウマチ |
| M06.0, M06.2, M06.3, M06.8, M06.9 | その他の関節リウマチ |
| M08.0, M08.3, M08.4, M08.8, M08.9 | 若年性関節炎 |

**除外コード**: M06.1（成人発症スティル病）, M06.4（炎症性多発性関節症）, M08.1, M08.2

### 3.2 各定義の比較

```
Definition 0: ICD-10コードのみ
Definition 1: ICD-10 + DMARDs処方あり
Definition 2: ICD-10 + DMARDs 1ヶ月以上
Definition 3: ICD-10 + DMARDs 2ヶ月以上  ← 採用
Definition 4: ICD-10 + DMARDs 6ヶ月以上
Definition 5: ICD-10 + bDMARDs処方あり
Definition 6: ICD-10 + 手術あり
```

### 3.3 定義選択の理由

Definition 3を選択した理由：
- 感度と特異度のバランスが良い
- 他の疫学研究との比較可能性
- 偶発的な処方を除外しつつ、真のRA患者を捕捉

---

## 4. DMARDs分類

### 4.1 従来型合成DMARD（csDMARD）

| 略称 | 一般名 | 使用率（論文値） |
|------|--------|-----------------|
| MTX | メトトレキサート | 63.4% |
| SSZ | サラゾスルファピリジン | 24.9% |
| BUC | ブシラミン | 14.5% |
| TAC | タクロリムス | 10.6% |
| IGT | 金チオリンゴ酸ナトリウム | 4.7% |
| LEF | レフルノミド | 3.0% |

### 4.2 生物学的DMARD（bDMARD）

| カテゴリ | 薬剤 | 使用率 |
|---------|------|--------|
| TNFI | IFX, ETN, ADA, GLM, CZP | 13.5% |
| IL6I | TCZ, SAR | 6.0% |
| ABT | アバタセプト | 4.5% |

### 4.3 分子標的型合成DMARD（tsDMARD）

| カテゴリ | 薬剤 | 使用率 |
|---------|------|--------|
| JAKi | TOF, BAR | 1.0% |

---

## 5. 年齢層別分析

### 5.1 年齢層の定義

| グループ | 年齢範囲 |
|---------|---------|
| 16-19 | 16〜19歳 |
| 20-29 | 20〜29歳 |
| 30-39 | 30〜39歳 |
| 40-49 | 40〜49歳 |
| 50-59 | 50〜59歳 |
| 60-69 | 60〜69歳 |
| 70-79 | 70〜79歳 |
| 80-84 | 80〜84歳 |
| 85+ | 85歳以上 |

### 5.2 年齢層別の主な知見（論文より）

1. **有病率**: 70-79歳でピーク（約1.5%）
2. **女性比率**: 若年層で高く、高齢層で低下
3. **MTX使用率**: 高齢層で低下（腎機能低下のため）
4. **bDMARDs使用率**: 中年層で最も高い

---

## 6. コード実行方法

### 6.1 一括実行（推奨）

```bash
cd reprod_paper08
poetry run python scripts/generate_data.py
```

### 6.2 ノートブック個別実行

```bash
# Jupyter Lab起動
poetry run jupyter lab

# 以下の順で実行
# 1. notebooks/01_bronze_data_generation.ipynb
# 2. notebooks/02_silver_ra_definition.ipynb
# 3. notebooks/03_gold_analysis.ipynb
```

---

## 7. ディレクトリ構成

```
reprod_paper08/
├── README.md                 # プロジェクト概要
├── docs/
│   └── データフロー解説.md    # 本ドキュメント
├── data/
│   ├── bronze/              # 生データ
│   │   ├── patients.parquet
│   │   ├── re_receipt.parquet
│   │   ├── sy_disease.parquet
│   │   ├── iy_medication.parquet
│   │   └── si_procedure.parquet
│   ├── silver/              # 変換済みデータ
│   │   ├── ra_patients_def3.parquet
│   │   └── ra_definitions_summary.parquet
│   └── gold/                # 分析結果
│       ├── table2_age_distribution.csv
│       ├── table3_medication.csv
│       ├── table4_procedures.csv
│       └── summary.csv
├── notebooks/
│   ├── 01_bronze_data_generation.ipynb
│   ├── 02_silver_ra_definition.ipynb
│   └── 03_gold_analysis.ipynb
└── scripts/
    └── generate_data.py     # 一括実行スクリプト
```

---

## 8. 注意事項

### 8.1 ダミーデータについて

- 本プロジェクトのデータは**完全なダミーデータ**です
- 論文の統計値を参考に分布を設定していますが、実データではありません
- 研究フローの理解とノートブック開発の練習を目的としています

### 8.2 実データへの適用

実際のNDBデータに適用する場合：
1. Bronze層のデータ読み込み部分を実データに置き換え
2. カラム名・コード体系の確認と調整
3. データ品質チェックの追加
4. 倫理審査・データ利用申請の確認

---

## 9. 参考文献

1. Nakajima A, et al. (2020) Prevalence of patients with rheumatoid arthritis and age-stratified trends in clinical characteristics and treatment. Modern Rheumatology.

2. NDB オープンデータ - 厚生労働省

3. Medallion Architecture - Databricks
