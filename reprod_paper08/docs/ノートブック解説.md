# ノートブック解説

本ドキュメントでは、各ノートブックの役割と実装のポイントを解説します。

---

## 1. 01_bronze_data_generation.ipynb

### 目的
NDBレセプトデータを模したダミーデータを生成し、Bronze層に保存する。

### 生成するテーブル

| テーブル | 対応するNDBデータ | 主要カラム |
|---------|------------------|-----------|
| patients | 患者マスタ | 共通キー, 年齢, 性別, 生年月日 |
| re_receipt | RE: レセプト共通 | 共通キー, 検索番号, 診療年月 |
| sy_disease | SY: 傷病名 | 共通キー, ICD10コード |
| iy_medication | IY: 医薬品 | 共通キー, 医薬品コード |
| si_procedure | SI: 診療行為 | 共通キー, procedure_type |

### 実装のポイント

```python
# 1. 確率分布の正規化
# AGE_GROUP_RA_DISTRIBUTIONの合計が100にならない場合に対応
age_probs = np.array(list(AGE_GROUP_RA_DISTRIBUTION.values()))
age_probs = age_probs / age_probs.sum()

# 2. ハッシュキーによる擬似匿名化
def generate_hash_key(patient_id: int) -> str:
    return hashlib.sha256(f"patient_{patient_id}".encode()).hexdigest()[:32]

# 3. 年齢依存の薬剤使用率調整
mtx_rate = DRUG_USAGE_RATES["MTX"] * (0.6 if age >= 85 else 0.8 if age >= 80 else 1.0)
```

### 出力ファイル
- `data/bronze/patients.parquet`
- `data/bronze/re_receipt.parquet`
- `data/bronze/sy_disease.parquet`
- `data/bronze/iy_medication.parquet`
- `data/bronze/si_procedure.parquet`

---

## 2. 02_silver_ra_definition.ipynb

### 目的
Bronze層のデータにRA患者定義を適用し、Silver層に保存する。

### RA患者定義の実装

```python
# Definition 0: ICD-10コードのみ
definition_0 = set(df_sy[df_sy["ICD10コード"].isin(RA_ICD10_CODES)]["共通キー"].unique())

# DMARDs処方月数の計算
df_dmard_months = (
    df_dmard
    .groupby("共通キー")["診療年月"]
    .nunique()
    .reset_index()
)
df_dmard_months.columns = ["共通キー", "prescription_months"]

# Definition 3: ICD-10 + DMARDs 2ヶ月以上
definition_3 = definition_0 & set(
    df_dmard_months[df_dmard_months["prescription_months"] >= 2]["共通キー"]
)
```

### 薬剤使用フラグの付与

```python
drug_categories = {
    "MTX": ["1199101", "1199102"],
    "TNFI": ["4400101", "4400102", "4400103", "4400104", "4400105"],
    # ...
}

for cat_name, codes in drug_categories.items():
    patients_with_drug = set(
        df_ra_meds[df_ra_meds["医薬品コード"].isin(codes)]["共通キー"]
    )
    df_ra_patients[cat_name] = df_ra_patients["共通キー"].isin(patients_with_drug)
```

### 出力ファイル
- `data/silver/ra_patients_def3.parquet` - RA患者マスタ（薬剤・手術フラグ付き）
- `data/silver/ra_definitions_summary.parquet` - 各定義の患者数比較

---

## 3. 03_gold_analysis.ipynb

### 目的
Silver層のデータを集計し、論文のTable 2-4を再現する。

### Table 2: 年齢層別患者分布

```python
for age_group in age_group_order:
    ra_group = df_ra_patients[df_ra_patients["age_group"] == age_group]
    n_ra = len(ra_group)
    n_female = (ra_group["sex"] == "2").sum()
    n_male = (ra_group["sex"] == "1").sum()
    
    table2_data.append({
        "Age Group": age_group,
        "N": n_ra,
        "% of Total": n_ra / total_ra * 100,
        "Female %": n_female / n_ra * 100 if n_ra > 0 else 0,
        "F/M Ratio": n_female / n_male if n_male > 0 else "N/A",
    })
```

### Table 3: 年齢層別薬剤使用率

```python
drug_cols = ["MTX", "SSZ", "BUC", "TAC", "TNFI", "IL6I", "ABT", "JAKi", "CS", "bDMARDs"]

for age_group in age_group_order:
    ra_group = df_ra_patients[df_ra_patients["age_group"] == age_group]
    row = {"Age Group": age_group, "N": len(ra_group)}
    
    for col in drug_cols:
        row[col] = ra_group[col].mean() * 100 if len(ra_group) > 0 else 0
    
    # TNFI/ABT比
    if ra_group["ABT"].mean() > 0:
        row["TNFI/ABT"] = ra_group["TNFI"].mean() / ra_group["ABT"].mean()
```

### Table 4: 年齢層別手術実施率

```python
proc_cols = ["TJR", "ARTHROPLASTY", "SYNOVECTOMY", "ULTRASOUND", "BMD", "any_RA_surgery"]

for age_group in age_group_order:
    ra_group = df_ra_patients[df_ra_patients["age_group"] == age_group]
    row = {"Age Group": age_group, "N": len(ra_group)}
    
    for col in proc_cols:
        row[col] = ra_group[col].mean() * 100 if len(ra_group) > 0 else 0
```

### 出力ファイル
- `data/gold/table2_age_distribution.csv`
- `data/gold/table3_medication.csv`
- `data/gold/table4_procedures.csv`
- `data/gold/summary.csv`

---

## 4. 開発のベストプラクティス

### 4.1 Parquetフォーマットの使用

```python
# CSVよりParquetを優先（型保持、圧縮、高速読み込み）
df.to_parquet("data/bronze/patients.parquet", index=False)
df = pd.read_parquet("data/bronze/patients.parquet")

# Gold層はCSVも併用（可読性のため）
df.to_csv("data/gold/summary.csv", index=False)
```

### 4.2 再現性の確保

```python
# 乱数シードの固定
np.random.seed(42)

# バージョン情報の記録
import pandas as pd
import numpy as np
print(f"pandas: {pd.__version__}")
print(f"numpy: {np.__version__}")
```

### 4.3 段階的なデータ検証

```python
# 各段階でデータ件数を確認
print(f"Bronze - 患者数: {len(df_patients)}")
print(f"Silver - RA患者数: {len(df_ra_patients)}")
print(f"Gold - 出力行数: {len(df_table2)}")

# 主要指標の妥当性確認
prevalence = len(df_ra_patients) / len(df_patients) * 100
assert 0.1 < prevalence < 5.0, f"有病率が異常: {prevalence}%"
```

---

## 5. トラブルシューティング

### Q1: Parquet保存でエラーが出る

**原因**: pyarrowがインストールされていない

**解決策**:
```bash
poetry add pyarrow
```

### Q2: 確率の合計が1にならないエラー

**原因**: `AGE_GROUP_RA_DISTRIBUTION`の値が正確に100にならない

**解決策**:
```python
age_probs = np.array(list(AGE_GROUP_RA_DISTRIBUTION.values()))
age_probs = age_probs / age_probs.sum()  # 正規化
```

### Q3: Jupyter NotebookでAsyncIOエラー

**原因**: イベントループの競合

**解決策**:
```python
import nest_asyncio
nest_asyncio.apply()
```

または、スクリプトとして実行:
```bash
poetry run python scripts/generate_data.py
```

---

## 6. 拡張のアイデア

### 6.1 可視化の追加

```python
import matplotlib.pyplot as plt
import seaborn as sns

# 年齢分布のヒストグラム
plt.figure(figsize=(10, 6))
df_ra_patients["age"].hist(bins=20)
plt.xlabel("Age")
plt.ylabel("Count")
plt.title("Age Distribution of RA Patients")
```

### 6.2 他の定義との比較

```python
# 7つの定義すべてを比較
definitions = ["def_0", "def_1", "def_2", "def_3", "def_4", "def_5", "def_6"]
for defn in definitions:
    prevalence = len(ra_definitions[defn]) / len(df_patients) * 100
    print(f"{defn}: {prevalence:.2f}%")
```

### 6.3 時系列分析

```python
# 月別のRA患者受診数
df_monthly = (
    df_re[df_re["共通キー"].isin(ra_patients_def3)]
    .groupby("診療年月")
    .agg({"共通キー": "nunique"})
    .reset_index()
)
```
